<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat With Spring Boot & Websocket</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/Chat.css}">
    <style>
        #messageArea {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .message-time {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            text-align: right;
        }
        .message-content {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="logo"><span class="servi">Servi</span><span class="mark">Marketing</span></div>
    <div class="nav">Chat</div>
</div>

<div class="main">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>TechTracking</h2>
        <nav>
            <ul>
                <li><a href="javascript:void(0)" onclick="window.history.back()">📅 Vista general</a></li>
            </ul>
        </nav>
        <div class="bottom-content">
            <div class="sidebar-img">
                <img th:src="@{/img/smg.png}" alt="Logo">
            </div>
            <form action="/logout" method="post">
                <button class="logout">Cerrar Sesión</button>
            </form>
        </div>
    </aside>

    <!-- Contenido principal -->
    <div class="container">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Chat en Tiempo Real</h5>
            <div id="messageArea"></div>

            <div class="mb-3">
                <label for="username" class="form-label">Nombre de Usuario:</label>
                <input type="text" class="form-control" id="username" placeholder="Introduce tu nombre">
            </div>

            <div class="mb-3">
                <label for="messageInput" class="form-label">Mensaje:</label>
                <input type="text" class="form-control" id="messageInput" placeholder="Introduce tu mensaje">
            </div>

            <button onclick="sendMessage()" class="btn btn-primary">Enviar</button>
            <div id="connectionStatus" class="mt-2"></div>
        </div>
    </div>
</div>

<script th:src="@{/js/Chat.js}"></script>
<script th:inline="javascript">
    let socket = new WebSocket("ws://localhost:8080/websocket");
    let messageArea = document.getElementById("messageArea");
    let connectionStatus = document.getElementById("connectionStatus");

    socket.onopen = function(event) {
        console.log("Conectado al WebSocket");
        connectionStatus.innerHTML = '<span class="badge bg-success">Conectado</span>';
    };

    function getCurrentDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        const time = now.toLocaleTimeString('es-CO', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        return `${date} ${time}`;
    }

    socket.onmessage = function(event) {
        console.log("Mensaje recibido:", event.data);

        // Crear nuevo elemento de mensaje
        let messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        
        // Crear el contenido del mensaje
        let contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = event.data;
        
        // Crear la marca de tiempo
        let timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = getCurrentDateTime();
        
        // Agregar contenido y tiempo al mensaje
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(timeDiv);

        // Agregar al área de mensajes
        messageArea.appendChild(messageDiv);

        // Scroll automático hacia abajo
        messageArea.scrollTop = messageArea.scrollHeight;
    };

    socket.onclose = function(event) {
        console.log("Conexión cerrada");
        connectionStatus.innerHTML = '<span class="badge bg-danger">Desconectado</span>';
    };

    socket.onerror = function(error) {
        console.log("Error en WebSocket:", error);
        connectionStatus.innerHTML = '<span class="badge bg-warning">Error de conexión</span>';
    };

    function sendMessage() {
        let username = document.getElementById("username");
        let messageInput = document.getElementById("messageInput");

        if (username.value.trim() === '' || messageInput.value.trim() === '') {
            alert('Por favor, completa todos los campos');
            return;
        }

        if (socket.readyState === WebSocket.OPEN) {
            let fullMessage = username.value + ": " + messageInput.value;
            socket.send(fullMessage);
            messageInput.value = '';
        } else {
            alert('No hay conexión con el servidor');
        }
    }

    // Permitir enviar con Enter
    document.getElementById("messageInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });
</script>-->
</body>
</html>